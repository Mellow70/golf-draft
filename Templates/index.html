<!DOCTYPE html>
<html>
<head>
    <title>{{ tournament }} Draft</title>
    <style>
        body { background-color: #f0f8e6; font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        header { background-color: #006400; color: white; text-align: left; padding: 10px; font-size: 24px; font-weight: bold; }
        #timer { font-size: 18px; margin: 10px 0; }
        #notification { color: #ff4500; font-style: italic; }
        h2 { margin-top: 20px; color: #333; }
        ul.teams { list-style-type: none; padding: 0; width: 50%; }
        ul.teams li { margin: 5px 0; padding: 5px; background-color: white; border: 1px solid #ddd; border-radius: 4px; }
        .participant { font-weight: bold; color: #2f4f4f; }
        form { margin: 20px 0; }
        select, button { padding: 5px; font-size: 16px; }
        #instructions { position: relative; margin-top: 20px; left: 0; width: 450px; background-color: #fffacd; border: 1px solid #ddd; padding: 10px; border-radius: 4px; font-size: 16px; font-weight: bold; }
        #instructions ul { list-style-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10"><circle cx="5" cy="5" r="5" fill="white" stroke="black"/></svg>'); padding-left: 20px; }
    </style>
    <script>
        let lastPickCount = {{ current_picks | default(0) }};

        function updateTimer() {
            fetch('/get_timer')
            .then(response => response.json())
            .then(data => {
                if ('time_left' in data) {
                    let timeLeft = data.time_left;
                    document.getElementById('timer').innerText = `Time Left: ${Math.floor(timeLeft / 60)}:${(timeLeft % 60).toString().padStart(2, '0')}`;
                    if (timeLeft === 0) {
                        console.log("Timer hit zero, checking for auto-pick");
                        setTimeout(() => location.reload(), 1000);  // Reload after auto-pick
                    }
                } else if (data.status === 'success') {
                    location.reload();  // Auto-pick happened
                }
            })
            .catch(error => console.log("Timer error:", error));
        }

        function autoPick() {
            console.log("Auto-picking triggered by timer");
            const player = document.querySelector('input[name="player"]').value;
            const round = document.querySelector('input[name="round"]').value;
            fetch('/auto_pick', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `player=${encodeURIComponent(player)}&round=${encodeURIComponent(round)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log(`Auto-picked: ${data.pick}`);
                    document.getElementById('notification').innerText = `Auto-picked: ${data.pick}`;
                    setTimeout(() => { document.getElementById('notification').innerText = ''; }, 3000);
                    location.reload();
                } else {
                    alert('Auto-pick failed: ' + data.message);
                }
            })
            .catch(error => console.log("Auto-pick error:", error));
        }

        function submitPick(event) {
            console.log("Submit intercepted");
            event.preventDefault();
            const form = document.getElementById('pickForm');
            const data = new FormData(form);
            fetch('/submit', {
                method: 'POST',
                body: data
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log("Pick successful, reloading");
                    location.reload();
                } else {
                    alert('Pick failed: ' + data.message);
                }
            })
            .catch(error => console.log("Submit error:", error));
        }

        function checkForUpdates() {
            fetch('/check_picks')
            .then(response => response.json())
            .then(data => {
                if (data.pick_count > lastPickCount) {
                    console.log("New pick detected, reloading");
                    lastPickCount = data.pick_count;
                    location.reload();
                }
            })
            .catch(error => console.log("Check error:", error));
        }

        window.onload = function() {
            console.log("Page loaded, setting up listeners");
            {% if not draft_complete %}
            setInterval(updateTimer, 5000);  // Update timer every 5 seconds
            setInterval(checkForUpdates, 2000);
            {% if is_user_turn %}
            document.getElementById('pickForm').addEventListener('submit', submitPick);
            {% endif %}
            {% endif %}
        };
    </script>
</head>
<body>
    <header>{{ tournament }}</header>
    <p>Logged in as: {{ username }} | <a href="/logout">Logout</a></p>
    {% if draft_complete %}
    <h1>{{ message }}</h1>
    {% else %}
    <h1>Current Turn: {{ turn }}</h1>
    <div id="timer">Time Left: 5:00</div>
    <p id="notification"></p>
    {% if is_user_turn %}
    <form id="pickForm" method="POST">
        <input type="hidden" name="player" value="{{ player }}">
        <input type="hidden" name="round" value="{{ round_num }}">
        <select name="golfer">
            {% for golfer in golfers %}
                <option value="{{ golfer.name }}">{{ golfer.name }} (Rank: {{ golfer.ranking }})</option>
            {% endfor %}
        </select>
        <button type="submit">Submit Pick</button>
    </form>
    {% else %}
    <p>Not your turn yet—please wait!</p>
    {% endif %}
    {% endif %}
    <h2>Teams</h2>
    <ul class="teams">
        {% for team in teams %}
            <li><span class="participant">{{ team[0] }}</span>: {{ team[1] }}, {{ team[2] }}, {{ team[3] }}</li>
        {% endfor %}
    </ul>
    <div id="instructions">
        <ul>
            <li>Welcome!</li>
            <li>The snake draft starts at 8pm, {{ draft_date }} based on the randomized order as listed</li>
            <li>Log in with your username and password—only pick when it’s your turn!</li>
            <li>You have 5 minutes to make your pick once your turn begins.</li>
            <li>If you miss the timer, an auto-pick selects the highest-ranked available golfer (based on rankings).</li>
            <li>Your selected golfers will appear next to your name—3 golfers total.</li>
            <li>Winner takes all!</li>
            <li>If no selected golfer wins, the highest-ranking golfer decides the winner.</li>
            <li>Good luck!</li>
        </ul>
    </div>
</body>
</html>